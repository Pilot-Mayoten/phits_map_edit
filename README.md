# PHITS Map Editor & Route Planner

PHITSを用いた放射線環境下でのロボット等の移動シミュレーションを支援するための、統合GUIアプリケーションです。

マップの視覚的な作成から、環境全体の線量マップ生成、被ばくを考慮した最適経路の探索、経路上の詳細な被ばく評価用ファイル生成、結果の3D可視化まで、一連のワークフローをシームレスに実行できます。

## 主な機能

-   **GUIによるマップ作成:** 壁や線源などの環境オブジェクトをグリッド上に直感的に配置。
-   **環境線量マップ生成:** 作成したマップに基づいて、PHITSによる空間全体の線量分布計算を実行（別途PHITSの実行が必要）。
-   **A\*アルゴリズムによる最適経路探索:** 環境線量マップを考慮し、移動距離と被ばく線量のバランスを取った最適経路を自動で探索。
-   **複数経路の管理:** スタート・ゴールは共通で、線源位置や核種、評価ステップ幅などが異なる複数の移動経路シナリオを定義・管理。
-   **詳細評価用ファイルの一括生成:** 定義した経路に沿って、ロボット（検出器）を模擬した多数のPHITS入力ファイルを一括で生成。
-   **3D可視化:** 定義した経路と線源の位置関係を3Dグラフで視覚的に確認。

## ファイル構成

コードは機能ごとにモジュール化されており、メンテナンス性と拡張性を高めています。

```
phits_map_edit/
├── main.py                     # アプリケーションの起動、各モジュールの統合
├── app_config.py               # マップサイズなどの共通設定値
├── map_editor_view.py          # マップエディタ部分のGUI
├── simulation_controls_view.py # シミュレーション制御部分のGUI
├── phits_handler.py            # PHITSの入出力ファイル関連の処理
├── route_calculator.py         # A*アルゴ-リズムや経路計算ロジック
├── visualizer.py               # Matplotlibによるグラフ描画処理
├── utils.py                    # 座標変換などの共通関数
├── template.inp                # 詳細評価用PHITS入力のテンプレート
└── README.md                   # このファイル
```

## 必要なもの

-   Windows OS
-   Python 3.8 以上
-   PHITS（別途インストールと環境変数設定が必要）
-   Pythonライブラリ:
    -   `tkinter` (Python標準ライブラリ)
    -   `matplotlib`

`matplotlib`は以下のコマンドでインストールできます。

```powershell
pip install matplotlib
```

## ワークフロー（使い方）

### ステップ1: マップの作成と環境線量マップの準備

1.  アプリケーションを起動します (`python main.py`)。
2.  左側の**マップエディタ**を使い、壁、線源、スタート、ゴール、中継地点を配置します。
3.  右側の**実行と可視化**パネルにある「**1. 環境線量マップ生成**」ボタンを押します。
    -   まず、環境定義用のPHITS入力ファイル (`env_input.inp`など) の保存を求められます。
    -   次に、この入力ファイルを使って**手動でPHITSを実行**してください。
    -   計算が終わると、出力として線量マップ (`deposit.out`など) が得られます。
4.  再度同じボタン（あるいは専用の読込ボタン）を押し、先ほど生成された`deposit.out`を読み込みます。マップ上にヒートマップとして線量分布が表示されます。

### ステップ2: 評価したい経路の定義

1.  右側の**経路定義**パネルで、詳細評価で使いたい線源の3次元物理座標、核種、放射能、評価ステップ幅（cm）を入力します。
    -   *注意: ここで入力する線源は、ステップ3の詳細評価シミュレーションで使われるもので、マップ上の線源とは独立しています。*
2.  「**経路を追加**」ボタンを押すと、現在のマップのスタート・ゴール・中継地点と、入力したパラメータが一つのセットとして下の**経路リスト**に追加されます。
3.  この作業を繰り返すことで、複数の評価シナリオ（経路）をリストに登録できます。

### ステップ3: 詳細評価用ファイルの生成と可視化

1.  「**3. 経路上の詳細線量評価**」ボタンを押します。
2.  シミュレーションファイル一式を保存するための**親フォルダ**を選択するよう求められます。
3.  指定したフォルダ内に、経路リストの各項目に対応するサブフォルダ (`route_001`, `route_002`...) が作成され、さらにその中に、評価ステップごとのPHITS入力ファイル (`input_000.inp`...) が一括生成されます。
4.  「**経路を3D表示**」ボタンを押すと、matplotlibのウィンドウが起動し、登録されている全経路の評価点と線源の位置関係を3Dで確認できます。

### ステップ4: 詳細評価の実行と結果解析 (今後の実装)

生成された入力ファイルを使い、PHITSのバッチ実行や結果の自動集計、グラフ化などを行います（この部分は現在開発中です）。

## `template.inp` について

このアプリケーションは、詳細評価用の入力ファイルを生成する際に `template.inp` というテンプレートファイルを利用します。このファイルには、ロボット（検出器）の形状や材質、線源の基本的な設定などが記述されています。

プログラムは、このテンプレートを読み込み、以下のプレースホルダを各評価点の具体的な値に置換して、多数の入力ファイルを生成します。

-   `{det_x}`, `{det_y}`, `{det_z}`: 検出器の中心座標
-   `{src_x}`, `{src_y}`, `{src_z}`: 線源の座標
-   `{nuclide_name}`, `{activity_value}`: 核種名と放射能
-   `{maxcas_value}`, `{maxbch_value}`: 計算回数など

ロボットの形状（サイズや材質など）を変更したい場合は、この`template.inp`の`[Surface]`や`[Cell]`セクションを直接編集してください。
