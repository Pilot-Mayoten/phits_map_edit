# PHITS Map Editor & Route Planner

PHITSを用いた放射線環境下でのロボット等の移動シミュレーションを支援するための、統合GUIアプリケーションです。

マップの視覚的な作成から、環境全体の線量マップ生成、被ばくを考慮した最適経路の探索、経路上の詳細な被ばく評価用ファイル生成、結果の3D可視化まで、一連のワークフローをシームレスに実行できます。

## 主な機能

-   **GUIによるマップ作成:** 壁や線源などの環境オブジェクトをグリッド上に直感的に配置。
-   **環境線量マップ生成:** 作成したマップに基づいて、PHITSによる空間全体の線量分布計算を実行（別途PHITSの実行が必要）。
-   **A\*アルゴリズムによる最適経路探索:** 環境線量マップを考慮し、移動距離と被ばく線量のバランスを取った最適経路を自動で探索。
-   **複数経路の管理:** スタート・ゴールは共通で、線源位置や核種、評価ステップ幅などが異なる複数の移動経路シナリオを定義・管理。
-   **詳細評価用ファイルの一括生成:** 定義した経路に沿って、ロボット（検出器）を模擬した多数のPHITS入力ファイルを一括で生成。
-   **3D可視化:** 定義した経路と線源の位置関係を3Dグラフで視覚的に確認。

## ファイル構成

コードは機能ごとにモジュール化されており、メンテナンス性と拡張性を高めています。

```
phits_map_edit/
├── main.py                     # アプリケーションの起動、各モジュールの統合
├── app_config.py               # マップサイズなどの共通設定値
├── map_editor_view.py          # マップエディタ部分のGUI
├── simulation_controls_view.py # シミュレーション制御部分のGUI
├── phits_handler.py            # PHITSの入出力ファイル関連の処理
├── route_calculator.py         # A*アルゴ-リズムや経路計算ロジック
├── visualizer.py               # Matplotlibによるグラフ描画処理
├── utils.py                    # 座標変換などの共通関数
├── template.inp                # 詳細評価用PHITS入力のテンプレート
└── README.md                   # このファイル
```

## 必要なもの

-   Windows OS
-   Python 3.8 以上
-   PHITS（別途インストールと環境変数設定が必要）
-   Pythonライブラリ:
    -   `tkinter` (Python標準ライブラリ)
    -   `matplotlib`

`matplotlib`は以下のコマンドでインストールできます。

```powershell
pip install matplotlib
```

## ワークフロー（使い方）

### ステップ1: マップの作成と環境線量マップの準備

1.  アプリケーションを起動します (`python main.py`)。
2.  左側の**マップエディタ**を使い、壁、線源、スタート、ゴールなどを配置します。
3.  右側の**実行と可視化**パネルにある「**1. 環境入力を生成**」ボタンを押します。
    -   環境定義用のPHITS入力ファイル (`env_input.inp`など) の保存を求められます。
4.  保存した入力ファイルを使って**手動でPHITSを実行**してください。
    -   計算が終わると、出力として線量マップ (`deposit.out`など) が得られます。
5.  「**2. 線量マップ読込**」ボタンを押し、先ほどPHITSで生成された`deposit.out`を読み込みます。マップ上にヒートマップとして線量分布が表示されます。

### ステップ2: 評価したい経路の定義とA*探索

1.  右側の**経路定義**パネルで、評価したい条件（ステップ数、核種、放射能など）を入力します。
2.  「**経路を追加**」ボタンを押すと、現在のマップのスタート・ゴール地点と入力したパラメータが一つのセットとして下の**経路リスト**に追加されます。
    -   この作業を繰り返すことで、複数の評価シナリオ（経路）をリストに登録できます。
3.  **経路リストからA*探索を適用したい経路を1つ選択**します。
4.  「**3. 最適経路を探索**」ボタンを押します。
    -   被ばく回避の重み係数を入力すると、A*アルゴリズムが実行されます。
    -   成功すると、回避経路がマップ上に描画され、選択した経路にその情報が紐付けられます。

### ステップ3: 詳細評価用ファイルの生成と可視化

1.  「**4. 経路上の詳細線量評価**」ボタンを押します。
2.  シミュレーションファイル一式を保存するための**親フォルダ**を選択するよう求められます。
3.  指定したフォルダ内に、経路リストの各項目に対応するサブフォルダ (`route_1`, `route_2`...) が作成されます。
    -   A*経路が紐付けられている経路は、その回避経路に沿った詳細評価ファイル (`detailed_point_...inp`) が生成されます。
    -   A*経路が紐付けられていない経路は、スタートとゴールを直線で結んだ経路でファイルが生成されます。
4.  「**経路を2D表示**」ボタンを押すと、matplotlibのウィンドウが起動し、登録されている全経路の評価点と線源の位置関係を2Dで確認できます。

## `template.inp` について

このアプリケーションは、詳細評価用の入力ファイルを生成する際に `template.inp` というテンプレートファイルを利用します。このファイルには、移動するロボット（立方体）の形状や材質、`[Transform]`による移動定義、線量検出器の設定などが記述されています。

プログラムは、このテンプレートを読み込み、以下のプレースホルダを各評価点の具体的な値に置換して、多数の入力ファイルを生成します。

-   `{det_x}`, `{det_y}`, `{det_z}`: ロボット（検出器）の中心座標。`[Transform]`セクションで利用されます。
-   `{maxcas_value}`, `{maxbch_value}`: 計算回数など。

ロボットの形状（サイズや材質など）を変更したい場合は、この`template.inp`の`[Surface]`や`[Cell]`、`[Material]`セクションを直接編集してください。
